name: Changelog UpdateCheck

on:
  push:
    branches-ignore:
      - master
  pull_request:
    branches:
      - master
    types: [opened, synchronize, reopened]

jobs:
  changelog-check:
    runs-on: ubuntu-latest
    name: Check CHANGELOG.md for updates
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check for CHANGELOG.md changes
        id: check_changelog
        run: |
          echo "üîç Checking for CHANGELOG.md changes..."
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          
          # For push events on feature branches, we need to compare against master
          # to see if CHANGELOG.md has been modified anywhere in this branch
          if git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
          elif git show-ref --verify --quiet refs/heads/master; then  
            BASE_REF="master"
          else
            echo "‚ö†Ô∏è  Cannot find master branch, using HEAD~1"
            BASE_REF="HEAD~1"
          fi
          
          echo "Comparing against: $BASE_REF"
          
          # Show changed files for debugging
          echo "All changed files in this branch:"
          git diff --name-only $BASE_REF...HEAD
          
          # Check if CHANGELOG.md was modified anywhere in this branch
          if git diff --name-only $BASE_REF...HEAD | grep -q "^CHANGELOG\.md$"; then
            echo "changelog_updated=true" >> $GITHUB_OUTPUT
            echo "‚úÖ CHANGELOG.md has been updated in this branch"
          else
            echo "changelog_updated=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  CHANGELOG.md has NOT been updated in this branch"
          fi
          
      - name: Show reminder (would comment on PR)
        if: steps.check_changelog.outputs.changelog_updated == 'false'
        run: |
          echo "üìù WOULD POST THIS COMMENT ON PR:"
          echo "=================================="
          echo "‚ö†Ô∏è This PR does not include changes to CHANGELOG.md"
          echo ""
          echo "Please consider updating the changelog if this PR includes:"
          echo "- New features"
          echo "- Bug fixes" 
          echo "- Breaking changes"
          echo "- Important updates"
          echo ""
          echo "Note: This is just a friendly reminder!"
          echo ""
          echo "‚ùå FAILING CHECK TO GET YOUR ATTENTION"
          exit 1
          
      - name: Success message
        if: steps.check_changelog.outputs.changelog_updated == 'true'
        run: |
          echo "üéâ SUCCESS: CHANGELOG.md has been updated!"
          echo "Thank you for documenting your changes."
