name: Changelog UpdateCheck

on:
  push:
    branches-ignore:
      - master
      - 'update-version-*'  # Ignore branches created by version update workflow
  pull_request:
    branches:
      - master
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  changelog-check:
    runs-on: ubuntu-latest
    name: Check CHANGELOG.md for updates
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if this is a version update commit
        id: check_version_commit
        run: |
          # Check if the commit message indicates this was created by the version update workflow
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == *"chore: update version in package.json"* ]]; then
            echo "is_version_commit=true" >> $GITHUB_OUTPUT
            echo "This is a version update commit, skipping changelog check..."
          else
            echo "is_version_commit=false" >> $GITHUB_OUTPUT
            echo "This is a regular commit, proceeding with changelog check..."
          fi
          
      - name: Check for CHANGELOG.md changes
        if: steps.check_version_commit.outputs.is_version_commit != 'true'
        id: check_changelog
        run: |
          echo "🔍 Checking for CHANGELOG.md changes..."
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          
          # Get the current branch name
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch: $BRANCH_NAME"
          
          # Try to find associated PR for this branch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # We have direct PR context
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            echo "PR event detected - using base SHA: $BASE_REF"
            echo "PR number: ${{ github.event.pull_request.number }}"
            echo "PR head SHA: ${{ github.event.pull_request.head.sha }}"
          else
            # For push events, try to find the PR and get its base
            echo "Push event - trying to find associated PR..."
            
            # Get PR info using GitHub API
            PR_INFO=$(curl -s -H "Authorization: token ${{ github.token }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:$BRANCH_NAME&state=open")
            
            if echo "$PR_INFO" | jq -e '.[0]' > /dev/null 2>&1; then
              BASE_REF=$(echo "$PR_INFO" | jq -r '.[0].base.sha')
              echo "Found PR - using base SHA: $BASE_REF"
            else
              # Fallback to master comparison
              if git show-ref --verify --quiet refs/remotes/origin/master; then
                BASE_REF="origin/master"
              elif git show-ref --verify --quiet refs/heads/master; then  
                BASE_REF="master"
              else
                echo "⚠️  Cannot find master branch, using HEAD~1"
                BASE_REF="HEAD~1"
              fi
              echo "No PR found - comparing against: $BASE_REF"
            fi
          fi
          
          # Show changed files for debugging
          echo "All changed files in this branch:"
          CHANGED_FILES=$(git diff --name-only $BASE_REF...HEAD)
          echo "$CHANGED_FILES"
          
          # Check if CHANGELOG.md was modified anywhere in this branch
          if echo "$CHANGED_FILES" | grep -q "^CHANGELOG\.md$"; then
            echo "changelog_updated=true" >> $GITHUB_OUTPUT
            echo "✅ CHANGELOG.md has been updated in this branch"
          else
            echo "changelog_updated=false" >> $GITHUB_OUTPUT
            echo "⚠️  CHANGELOG.md has NOT been updated in this branch"
            echo "Changed files found:"
            echo "$CHANGED_FILES" | while read file; do
              echo "  - $file"
            done
          fi
          
      - name: Get PR number
        if: steps.check_version_commit.outputs.is_version_commit != 'true'
        id: get_pr_number
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            # Get PR number from API for push events
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            PR_INFO=$(curl -s -H "Authorization: token ${{ github.token }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:$BRANCH_NAME&state=open")
            
            if echo "$PR_INFO" | jq -e '.[0]' > /dev/null 2>&1; then
              PR_NUMBER=$(echo "$PR_INFO" | jq -r '.[0].number')
              echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            else
              echo "pr_number=" >> $GITHUB_OUTPUT
            fi
          fi
          
      - name: Comment on PR (no changelog)
        if: steps.check_version_commit.outputs.is_version_commit != 'true' && steps.check_changelog.outputs.changelog_updated == 'false' && steps.get_pr_number.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `⚠️ **Changelog Reminder**
            
            This PR does not include changes to \`CHANGELOG.md\`
            
            Please consider updating the changelog if this PR includes:
            - 🆕 New features
            - 🐛 Bug fixes 
            - 💥 Breaking changes
            - 🔧 Important updates
            
            *This is just a friendly reminder!* 😊
            
            <!-- CHANGELOG-REMINDER-BOT -->`;
            
            const response = await github.rest.issues.createComment({
              issue_number: ${{ steps.get_pr_number.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            // Save the comment ID for potential deletion later
            core.setOutput('comment_id', response.data.id);
            console.log(`Comment created with ID: ${response.data.id}`);
            
      - name: Debug failure conditions
        if: steps.check_version_commit.outputs.is_version_commit != 'true' && steps.check_changelog.outputs.changelog_updated == 'false'
        run: |
          echo "🔍 Debugging failure conditions..."
          echo "Event name: ${{ github.event_name }}"
          echo "PR number: ${{ steps.get_pr_number.outputs.pr_number }}"
          echo "Changelog updated: ${{ steps.check_changelog.outputs.changelog_updated }}"
          echo "Should fail: ${{ github.event_name == 'pull_request' || steps.get_pr_number.outputs.pr_number != '' }}"
          
      - name: Fail check (no changelog)
        if: steps.check_version_commit.outputs.is_version_commit != 'true' && steps.check_changelog.outputs.changelog_updated == 'false' && (github.event_name == 'pull_request' || steps.get_pr_number.outputs.pr_number != '')
        run: |
          echo "❌ FAILING CHECK: CHANGELOG.md has not been updated"
          echo "A comment has been posted on the PR to remind you."
          exit 1
          
      - name: Warning (no changelog) - No PR
        if: steps.check_version_commit.outputs.is_version_commit != 'true' && steps.check_changelog.outputs.changelog_updated == 'false' && github.event_name == 'push' && steps.get_pr_number.outputs.pr_number == ''
        run: |
          echo "⚠️  WARNING: CHANGELOG.md has not been updated"
          echo "This is just a friendly reminder while you're iterating."
          echo "The check will fail when you create a PR."
          
      - name: Delete previous changelog reminder comments
        if: steps.check_version_commit.outputs.is_version_commit != 'true' && steps.check_changelog.outputs.changelog_updated == 'true' && steps.get_pr_number.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            console.log('🔍 Looking for previous changelog reminder comments to delete...');
            
            // Get all comments on the PR
            const comments = await github.rest.issues.listComments({
              issue_number: ${{ steps.get_pr_number.outputs.pr_number }},
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // Find and delete comments from github-actions bot that contain our specific changelog reminder
            let deletedCount = 0;
            for (const comment of comments.data) {
              // Very specific filter to only delete our changelog reminder comments
              if (comment.user.login === 'github-actions[bot]' && 
                  comment.body.includes('<!-- CHANGELOG-REMINDER-BOT -->')) {
                console.log(`🗑️  Deleting changelog reminder comment ID: ${comment.id}`);
                await github.rest.issues.deleteComment({
                  comment_id: comment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
                deletedCount++;
              }
            }
            
            if (deletedCount > 0) {
              console.log(`✅ Deleted ${deletedCount} previous changelog reminder comment(s)`);
            } else {
              console.log('ℹ️  No previous changelog reminder comments found to delete');
            }
            
      - name: Success message
        if: steps.check_version_commit.outputs.is_version_commit != 'true' && steps.check_changelog.outputs.changelog_updated == 'true'
        run: |
          echo "🎉 SUCCESS: CHANGELOG.md has been updated!"
          echo "Thank you for documenting your changes."
          echo "Previous changelog reminder comments have been cleaned up."
